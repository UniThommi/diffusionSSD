# ============================================================================
# NC-Score Configuration
# ============================================================================

[training]
# Run identifier (für separate Checkpoint-Ordner)
run_name = "nc_score_baseline_v1"

# Logging & Monitoring
enable_tensorboard = false
save_training_plots = true
save_history_json = true
plot_update_frequency = 10 

# Hardware
device = "cpu"  # "cpu" or "gpu"
enable_horovod = false

# Data files
data_dir = "/pscratch/sd/t/tbuerger/data/optPhotonSensitiveSurface/MLFormatHomogeneousNCsZylSSD300PMTs"
train_file = "resum_output_0_train.hdf5"
val_file = "resum_output_0_validation.hdf5"
train_val_split = 0.8

# Hyperparameters
batch_size = 4 # 32 in CaloScore
num_epochs = 100
learning_rate = 1e-4
optimizer = "Adamax"
use_cosine_decay = true  # learning_rate
early_stop_patience = 20

# EMA
ema_decay = 0.999

# Checkpointing
checkpoint_dir = "./checkpoints"

# Event limiting (null = use all events)
max_events = 100

# Distillation (NICHT IMPLEMENTIERT - nur Struktur)
enable_distillation = false
distillation_factor = 1

[model]
# Embedding dimension
embed_dim = 128

# ResNet (Area-Modell)
num_resnet_layers = 3
resnet_hidden_dim = 128

# UNet (Voxel-Modell pro Region)
unet_block_depth = 4
unet_widths = [32, 64, 96, 128]
unet_attentions = [false, true, true, true]
unet_stride = 2
unet_kernel = 3
unet_input_embedding_dims = 16

# Legacy padding (nur wenn use_auto_geometry=false)
[model.padding]
PIT  = [[2, 2], [2, 2]]
BOT  = [[6, 6], [6, 6]]
WALL = 0
TOP  = [[4, 4], [4, 4]]

# ============================================================================
# Geometry Configuration per Region
# ============================================================================

[geometry.PIT]
use_auto_geometry = false
SHAPE = [36, 36, 1]  # [n_r, n_phi, channels]
periodic_phi = false  # FIX: Not yet implemented
periodic_r = false    # FIX: Not yet implemented

[geometry.BOT]
use_auto_geometry = false
SHAPE = [20, 20, 1]  # [n_r, n_phi, channels]
periodic_phi = false  # FIX: Not yet implemented
periodic_r = false    # FIX: Not yet implemented

[geometry.WALL]
use_auto_geometry = true
# SHAPE wird automatisch inferiert aus Voxel-Indices
# Expected: [n_z, n_phi, 1] mit n_z*n_phi = 6394
periodic_phi = true   # Phi-Achse ist periodic (zylindrisch)
periodic_z = false    # Z-Achse ist non-periodic

[geometry.TOP]
use_auto_geometry = true
# SHAPE wird automatisch inferiert aus Voxel-Indices
# Expected: [n_y, n_x, 1] kartesisches Grid (Donut-Form)
periodic_y = false   # Y-Achse ist nicht periodic
periodic_x = false   # X-Achse ist nicht periodic

[diffusion]
num_steps = 512
logsnr_min = -20.0
logsnr_max = 20.0

[features]
active_phi = [
    "r_NC_mm",
    "phi_NC_rad",
    "zNC_mm",
    "E_gamma_tot_keV",
    "#gamma",
    "matID"
]

[onehot]
enable_material_onehot = true
enable_volume_onehot = false

[mapping]
material_mapping_file = "/global/cfs/projectdirs/legend/users/tbuerger/postprocessing/src/mappings/globalMaterialMappings.json"
volume_mapping_file = "/global/cfs/projectdirs/legend/users/tbuerger/postprocessing/src/mappings/globalPhysVolMappings.json"

[normalization]
r_cylinder = 4300.0
z_min = -5000.0
z_max = 3920.0
angle_max = 6.283185307
E_max = 40000.0
gamma_count_max = 20.0
region_hit_max_global = 128.0
voxel_hit_max = 128.0

[normalization.area_ratios]
PIT = 3.15
BOT = 1.0
WALL = 15.99
TOP = 3.82

[regions]
pit_prefix = "00"
bot_prefix = "01"
top_prefix = "99"
expected_voxel_counts = { PIT = 1261, BOT = 400, WALL = 6394, TOP = 1528 }

[training.active_regions]
# Welche Regionen trainiert werden sollen
enabled = ["PIT", "BOT", "WALL", "TOP"]  # Für alle 4: ["PIT", "BOT", "WALL", "TOP"]